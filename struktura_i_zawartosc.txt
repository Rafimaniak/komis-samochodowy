Eksport wybranych plikw
Wygenerowano: 12/12/2025 03:20:49



CIEKA: C:\Users\Rafimaniaak\ProjektJAVA\komis-samochodowy3\src\main\java\pl\komis\controller\ZakupController.java
----------------------------------------------------------------------------------------------------------------------
package pl.komis.controller;

import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import pl.komis.model.*;
import pl.komis.service.*;
import pl.komis.service.KlientService;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@Controller
@RequestMapping("/zakupy")
@RequiredArgsConstructor
public class ZakupController {

    private final ZakupService zakupService;
    private final UserService userService;
    private final KlientService klientService;
    private final SamochodService samochodService; // Dodaj to!
    private final PracownikService pracownikService; // Dodaj to!


    @GetMapping("/rabaty")
    @PreAuthorize("hasRole('ADMIN')")
    public String listaRabatow(Model model) {
        List<Klient> klienci = klientService.findAll();

        // Oblicz statystyki
        BigDecimal totalSaldo = klienci.stream()
                .map(k -> k.getSaldoPremii() != null ? k.getSaldoPremii() : BigDecimal.ZERO)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        BigDecimal totalWydane = klienci.stream()
                .map(k -> k.getTotalWydane() != null ? k.getTotalWydane() : BigDecimal.ZERO)
                .reduce(BigDecimal.ZERO, BigDecimal::add);

        long klienciZPremia = klienci.stream()
                .filter(k -> k.getProcentPremii() != null && k.getProcentPremii().compareTo(BigDecimal.ZERO) > 0)
                .count();

        model.addAttribute("klienci", klienci);
        model.addAttribute("totalSaldo", totalSaldo);
        model.addAttribute("totalWydane", totalWydane);
        model.addAttribute("klienciZPremia", klienciZPremia);
        model.addAttribute("tytul", "System premii i rabat贸w");
        return "zakupy/rabaty";
    }

    // Dla admina: pena lista zakup贸w
    @GetMapping
    @PreAuthorize("hasRole('ADMIN')")
    public String listZakupy(Model model) {
        List<Zakup> zakupy = zakupService.findAll();
        System.out.println("DEBUG: Pobrano " + zakupy.size() + " zakup贸w");
        model.addAttribute("zakupy", zakupy);
        model.addAttribute("tytul", "Lista Wszystkich Zakup贸w");
        return "zakupy/lista-admin";
    }

    // W metodzie wykorzystajSaldoForm w ZakupController.java ju偶 masz:
    @GetMapping("/wykorzystaj-saldo")
    @PreAuthorize("isAuthenticated()")
    public String wykorzystajSaldoForm(@RequestParam Long samochodId,
                                       @RequestParam BigDecimal cena,
                                       Authentication authentication,
                                       Model model) {
        String username = authentication.getName();

        User user = userService.findByUsername(username)
                .orElseThrow(() -> new RuntimeException("U偶ytkownik nie znaleziony"));

        if (user.getKlient() == null) {
            throw new RuntimeException("Nie masz powizanego klienta");
        }

        Klient klient = klientService.findById(user.getKlient().getId())
                .orElseThrow(() -> new RuntimeException("Klient nie znaleziony"));

        // Pobierz samoch贸d
        Samochod samochod = samochodService.findById(samochodId)
                .orElseThrow(() -> new RuntimeException("Samoch贸d nie znaleziony"));

        // SPRAWD殴 CZY SAMOCHD JEST ZAREZERWOWANY
        if ("ZAREZERWOWANY".equals(samochod.getStatus())) {
            if (samochod.getZarezerwowanyPrzez() == null) {
                throw new RuntimeException("Samoch贸d jest zarezerwowany, ale brak informacji o kliencie");
            } else if (!samochod.getZarezerwowanyPrzez().getId().equals(klient.getId())) {
                throw new RuntimeException("Ten samoch贸d jest zarezerwowany przez innego klienta. " +
                        "Tylko osoba rezerwujca mo偶e go kupi.");
            }
        }

        // Sprawd藕 czy samoch贸d jest dostpny
        if (!"DOSTEPNY".equals(samochod.getStatus()) && !"ZAREZERWOWANY".equals(samochod.getStatus())) {
            throw new RuntimeException("Samoch贸d nie jest dostpny do zakupu. Status: " + samochod.getStatus());
        }

        // Reszta metody pozostaje bez zmian...
        model.addAttribute("samochodId", samochodId);
        model.addAttribute("cenaBazowa", cena);
        model.addAttribute("klient", klient);
        model.addAttribute("saldoKlienta", klient.getSaldoPremii());
        model.addAttribute("maksWykorzystanie", cena.min(klient.getSaldoPremii()));

        // Dodaj informacj o samochodzie do modelu
        model.addAttribute("samochod", samochod);

        // Dodaj info o premii
        model.addAttribute("procentPremii", klient.getProcentPremii());
        if (klient.getProcentPremii().compareTo(BigDecimal.ZERO) > 0) {
            BigDecimal premia = cena.multiply(klient.getProcentPremii())
                    .divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP);
            model.addAttribute("premiaOdZakupu", premia);
        }

        // Dodaj list pracownik贸w
        List<Pracownik> pracownicy = pracownikService.findAll();
        model.addAttribute("pracownicy", pracownicy);

        return "zakupy/wykorzystaj-saldo";
    }
    // POST - wykonanie zakupu z saldem
    @PostMapping("/wykorzystaj-saldo")
    @PreAuthorize("isAuthenticated()")
    public String wykonajZakupZSaldem(@RequestParam Long samochodId,
                                      @RequestParam BigDecimal cenaBazowa,
                                      @RequestParam(required = false) BigDecimal wykorzystaneSaldo,
                                      @RequestParam Long pracownikId,
                                      Authentication authentication,
                                      RedirectAttributes redirectAttributes) {  // DODANO RedirectAttributes

        try {
            String username = authentication.getName();
            User user = userService.findByUsername(username)
                    .orElseThrow(() -> new RuntimeException("U偶ytkownik nie znaleziony"));

            Klient klient = user.getKlient();
            if (klient == null) {
                throw new RuntimeException("Nie masz powizanego klienta");
            }

            // Pobierz samoch贸d
            Samochod samochod = samochodService.findById(samochodId)
                    .orElseThrow(() -> new RuntimeException("Samoch贸d nie znaleziony"));

            // Sprawd藕 dostpno samochodu
            if (!samochod.getStatus().equals("DOSTEPNY") &&
                    !samochod.getStatus().equals("ZAREZERWOWANY")) {
                throw new RuntimeException("Samoch贸d nie jest dostpny do zakupu. Status: " + samochod.getStatus());
            }

            // Jeli klient zarezerwowa ten samoch贸d, to tylko on mo偶e go kupi
            if (samochod.getStatus().equals("ZAREZERWOWANY") &&
                    (samochod.getZarezerwowanyPrzez() == null ||
                            !samochod.getZarezerwowanyPrzez().getId().equals(klient.getId()))) {
                throw new RuntimeException("Ten samoch贸d jest zarezerwowany przez innego klienta. " +
                        "Tylko osoba rezerwujca mo偶e go kupi.");
            }

            // Pobierz pracownika
            Pracownik pracownik = pracownikService.findById(pracownikId)
                    .orElseThrow(() -> new RuntimeException("Pracownik nie znaleziony"));

            // Obsu偶 wykorzystanie salda (jeli podano)
            BigDecimal faktycznieWykorzystaneSaldo = BigDecimal.ZERO;
            if (wykorzystaneSaldo != null && wykorzystaneSaldo.compareTo(BigDecimal.ZERO) > 0) {
                // Sprawd藕 czy klient ma wystarczajce saldo
                if (klient.getSaldoPremii().compareTo(wykorzystaneSaldo) < 0) {
                    throw new RuntimeException("Niewystarczajce saldo premii");
                }
                faktycznieWykorzystaneSaldo = wykorzystaneSaldo.min(cenaBazowa);
            }

            // Oblicz naliczon premi
            BigDecimal naliczonaPremia = BigDecimal.ZERO;
            if (klient.getProcentPremii() != null &&
                    klient.getProcentPremii().compareTo(BigDecimal.ZERO) > 0) {
                naliczonaPremia = cenaBazowa
                        .multiply(klient.getProcentPremii())
                        .divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP);
            }

            // Oblicz kocow cen zakupu
            BigDecimal cenaZakupu = cenaBazowa.subtract(faktycznieWykorzystaneSaldo);

            // Utw贸rz zakup
            Zakup zakup = new Zakup();
            zakup.setSamochod(samochod);
            zakup.setKlient(klient);
            zakup.setPracownik(pracownik);
            zakup.setCenaBazowa(cenaBazowa);
            zakup.setWykorzystaneSaldo(faktycznieWykorzystaneSaldo);
            zakup.setNaliczonaPremia(naliczonaPremia);
            zakup.setCenaZakupu(cenaZakupu);
            zakup.setDataZakupu(LocalDate.from(LocalDateTime.now()));
            zakup.setZastosowanyRabat(klient.getProcentPremii());

            // Zapisz zakup
            zakupService.save(zakup);

            // ZMIANA STATUSU SAMOCHODU NA SPRZEDANY
            samochod.setStatus("SPRZEDANY");
            samochod.setZarezerwowanyPrzez(null); // Wyczy rezerwacj po zakupie
            samochod.setDataRezerwacji(null);
            samochodService.save(samochod);

            // Aktualizuj dane klienta (liczba zakup贸w, wydane kwoty)
            klient.setLiczbaZakupow(klient.getLiczbaZakupow() + 1);
            klient.setTotalWydane(klient.getTotalWydane().add(cenaZakupu));

            // Dodaj premi do salda klienta
            klient.setSaldoPremii(klient.getSaldoPremii().add(naliczonaPremia));

            // Odejmij wykorzystane saldo
            klient.setSaldoPremii(klient.getSaldoPremii().subtract(faktycznieWykorzystaneSaldo));

            // Aktualizuj procent premii na podstawie liczby zakup贸w
            if (klient.getLiczbaZakupow() >= 5) {
                klient.setProcentPremii(new BigDecimal("15"));
            } else if (klient.getLiczbaZakupow() >= 3) {
                klient.setProcentPremii(new BigDecimal("10"));
            } else if (klient.getLiczbaZakupow() >= 2) {
                klient.setProcentPremii(new BigDecimal("5"));
            } else {
                klient.setProcentPremii(BigDecimal.ZERO);
            }

            klientService.save(klient);

            // Przygotuj komunikat sukcesu
            String message;
            if (faktycznieWykorzystaneSaldo.compareTo(BigDecimal.ZERO) > 0) {
                BigDecimal zaoszczedzone = faktycznieWykorzystaneSaldo;
                message = String.format(
                        "Samoch贸d kupiony z wykorzystaniem salda!<br>" +
                                "Wykorzystano saldo: <strong>%.2f z</strong><br>" +
                                "Na Twoje saldo dodano: <strong>%.2f z</strong> premii<br>" +
                                "Nowe saldo: <strong>%.2f z</strong>",
                        zaoszczedzone, naliczonaPremia, klient.getSaldoPremii()
                );
            } else {
                message = String.format(
                        "Samoch贸d kupiony pomylnie!<br>" +
                                "Na Twoje saldo dodano: <strong>%.2f z</strong> premii",
                        naliczonaPremia
                );
            }

            redirectAttributes.addFlashAttribute("successMessage", message);

            return "redirect:/zakupy/moje";

        } catch (Exception e) {
            System.err.println("Bd podczas zakupu z wykorzystaniem salda: " + e.getMessage());
            e.printStackTrace();

            // Przekieruj z bdem
            redirectAttributes.addFlashAttribute("errorMessage",
                    "Bd podczas zakupu: " + e.getMessage());
            return "redirect:/samochody/szczegoly?id=" + samochodId;
        }
    }

    // Dla u偶ytkownika: tylko jego zakupy - ZMIENIONE: teraz przekazujemy obiekt Klient
    @GetMapping("/moje")
    @PreAuthorize("isAuthenticated()")
    public String mojeZakupy(Authentication authentication, Model model) {
        String username = authentication.getName();

        try {
            User user = userService.findByUsername(username)
                    .orElseThrow(() -> new RuntimeException("U偶ytkownik nie znaleziony"));

            List<Zakup> zakupy = List.of();
            Klient klient = null;

            // U偶yj metody ensureUserHasKlient zamiast rcznego tworzenia
            klient = userService.ensureUserHasKlient(user.getId());

            // Pobierz zakupy klienta
            Long klientId = klient.getId();
            zakupy = zakupService.findByKlientId(klientId);

            // OBLICZ SUMY DLA STATYSTYK
            BigDecimal sumaCenaBazowa = zakupy.stream()
                    .map(z -> z.getCenaBazowa() != null ? z.getCenaBazowa() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaWykorzystaneSaldo = zakupy.stream()
                    .map(z -> z.getWykorzystaneSaldo() != null ? z.getWykorzystaneSaldo() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaNaliczonaPremia = zakupy.stream()
                    .map(z -> z.getNaliczonaPremia() != null ? z.getNaliczonaPremia() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaCenaZakupu = zakupy.stream()
                    .map(z -> z.getCenaZakupu() != null ? z.getCenaZakupu() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            // Dodaj do modelu
            model.addAttribute("sumaCenaBazowa", sumaCenaBazowa);
            model.addAttribute("sumaWykorzystaneSaldo", sumaWykorzystaneSaldo);
            model.addAttribute("sumaNaliczonaPremia", sumaNaliczonaPremia);
            model.addAttribute("sumaCenaZakupu", sumaCenaZakupu);

            System.out.println("DEBUG: Klient ID: " + klientId);
            System.out.println("DEBUG: Procent premii: " + klient.getProcentPremii() + "%");
            System.out.println("DEBUG: Saldo premii: " + klient.getSaldoPremii() + " z");
            System.out.println("DEBUG: cznie wydano: " + klient.getTotalWydane() + " z");
            System.out.println("DEBUG: Liczba zakup贸w: " + klient.getLiczbaZakupow());

            model.addAttribute("zakupy", zakupy);
            model.addAttribute("klient", klient);
            model.addAttribute("tytul", "Moje Zakupy");
            model.addAttribute("username", username);
            return "zakupy/lista-klient";

        } catch (Exception e) {
            System.err.println("BD w mojeZakupy: " + e.getMessage());
            e.printStackTrace();
            model.addAttribute("errorMessage", "Bd podczas adowania zakup贸w: " + e.getMessage());
            return "error";
        }
    }
    // GET - szczeg贸y zakup贸w klienta (dla admina)
    @GetMapping("/moje/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public String zakupyKlienta(@PathVariable Long id, Model model) {
        try {
            // Znajd藕 klienta
            Klient klient = klientService.findById(id)
                    .orElseThrow(() -> new RuntimeException("Klient nie znaleziony"));

            // Pobierz zakupy klienta
            List<Zakup> zakupy = zakupService.findByKlientId(id);

            // Oblicz statystyki
            BigDecimal sumaCenaBazowa = zakupy.stream()
                    .map(z -> z.getCenaBazowa() != null ? z.getCenaBazowa() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaWykorzystaneSaldo = zakupy.stream()
                    .map(z -> z.getWykorzystaneSaldo() != null ? z.getWykorzystaneSaldo() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaNaliczonaPremia = zakupy.stream()
                    .map(z -> z.getNaliczonaPremia() != null ? z.getNaliczonaPremia() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            BigDecimal sumaCenaZakupu = zakupy.stream()
                    .map(z -> z.getCenaZakupu() != null ? z.getCenaZakupu() : BigDecimal.ZERO)
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            // Dodaj do modelu
            model.addAttribute("zakupy", zakupy);
            model.addAttribute("klient", klient);
            model.addAttribute("sumaCenaBazowa", sumaCenaBazowa);
            model.addAttribute("sumaWykorzystaneSaldo", sumaWykorzystaneSaldo);
            model.addAttribute("sumaNaliczonaPremia", sumaNaliczonaPremia);
            model.addAttribute("sumaCenaZakupu", sumaCenaZakupu);
            model.addAttribute("tytul", "Zakupy klienta: " + klient.getImie() + " " + klient.getNazwisko());

            return "zakupy/lista-klient";

        } catch (Exception e) {
            System.err.println("BD w zakupyKlienta: " + e.getMessage());
            e.printStackTrace();
            model.addAttribute("errorMessage", "Bd podczas adowania zakup贸w: " + e.getMessage());
            return "error";
        }
    }

    // GET - szczeg贸y konkretnego zakupu (dla admina)
    @GetMapping("/szczegoly/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public String szczegolyZakupu(@PathVariable Long id, Model model) {
        try {
            Zakup zakup = zakupService.findById(id)
                    .orElseThrow(() -> new RuntimeException("Zakup nie znaleziony"));

            model.addAttribute("zakup", zakup);
            model.addAttribute("tytul", "Szczeg贸y zakupu #" + zakup.getId());

            return "zakupy/szczegoly";
        } catch (Exception e) {
            System.err.println("BD w szczegolyZakupu: " + e.getMessage());
            e.printStackTrace();
            model.addAttribute("errorMessage", "Bd podczas adowania zakupu: " + e.getMessage());
            return "error";
        }

    }


    // Pomocnicza metoda do znajdowania zakup贸w po emailu klienta
    private List<Zakup> findZakupyByUserEmail(String email) {
        // Najpierw znajd藕 klienta po emailu
        return klientService.findByEmail(email)
                .map(klient -> zakupService.findByKlientId(klient.getId()))
                .orElse(List.of());
    }


    // Usuwanie tylko dla admina
    @PostMapping("/usun/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public String deleteZakup(@PathVariable Long id) {
        zakupService.remove(id);
        return "redirect:/zakupy";
    }
}


CIEKA: C:\Users\Rafimaniaak\ProjektJAVA\komis-samochodowy3\src\main\java\pl\komis\service\ZakupService.java
----------------------------------------------------------------------------------------------------------------
package pl.komis.service;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import pl.komis.model.*;
import pl.komis.repository.*;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class ZakupService {

    private final ZakupRepository zakupRepository;
    private final KlientRepository klientRepository;
    private final SamochodService samochodService;
    private final PracownikService pracownikService;
    private final UserService userService;

    public Zakup createZakupZSaldem(Long samochodId, Long userId, Long pracownikId,
                                    BigDecimal cenaBazowa, BigDecimal wykorzystaneSaldo) {
        // Pobierz samoch贸d
        Samochod samochod = samochodService.findById(samochodId)
                .orElseThrow(() -> new RuntimeException("Samoch贸d nie znaleziony"));

        // Pobierz u偶ytkownika
        User user = userService.findById(userId)
                .orElseThrow(() -> new RuntimeException("U偶ytkownik nie znaleziony"));

        // Pobierz klienta
        Klient klient = user.getKlient();
        if (klient == null) {
            throw new RuntimeException("U偶ytkownik nie ma powizanego klienta");
        }

        // Pobierz pracownika
        Pracownik pracownik = pracownikService.findById(pracownikId)
                .orElseThrow(() -> new RuntimeException("Pracownik nie znaleziony"));

        // Walidacja: wykorzystane saldo nie mo偶e przekracza ceny samochodu
        if (wykorzystaneSaldo != null && wykorzystaneSaldo.compareTo(cenaBazowa) > 0) {
            throw new RuntimeException("Wykorzystane saldo nie mo偶e przekracza ceny samochodu");
        }

        // Walidacja: sprawd藕 czy klient ma wystarczajce saldo
        BigDecimal faktycznieWykorzystane = (wykorzystaneSaldo != null) ? wykorzystaneSaldo : BigDecimal.ZERO;
        if (faktycznieWykorzystane.compareTo(BigDecimal.ZERO) > 0) {
            if (klient.getSaldoPremii() == null ||
                    klient.getSaldoPremii().compareTo(faktycznieWykorzystane) < 0) {
                throw new RuntimeException("Niewystarczajce saldo premii. Masz: " +
                        klient.getSaldoPremii() + " z, a potrzebujesz: " +
                        faktycznieWykorzystane + " z");
            }
        }

        // Oblicz cen kocow (trigger w bazie r贸wnie偶 to zrobi, ale potrzebujemy w Javie)
        BigDecimal cenaKoncowa = cenaBazowa.subtract(faktycznieWykorzystane);

        // Pobierz aktualny procent premii klienta
        BigDecimal procentPremii = klient.getProcentPremii();

        // Oblicz premi od tego zakupu (procent od ceny bazowej)
        // UWAGA: Trigger w bazie r贸wnie偶 to obliczy i zapisze!
        BigDecimal naliczonaPremia = BigDecimal.ZERO;
        if (procentPremii != null && procentPremii.compareTo(BigDecimal.ZERO) > 0) {
            naliczonaPremia = cenaBazowa.multiply(procentPremii)
                    .divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);
        }

        // Utw贸rz nowy zakup
        Zakup zakup = Zakup.builder()
                .samochod(samochod)
                .klient(klient)
                .pracownik(pracownik)
                .dataZakupu(LocalDate.now())
                .cenaBazowa(cenaBazowa)
                .cenaZakupu(cenaKoncowa)
                .zastosowanyRabat(procentPremii)
                .naliczonaPremia(naliczonaPremia)
                .wykorzystaneSaldo(faktycznieWykorzystane)
                .build();

        // NIE aktualizujemy rcznie salda klienta - robi to trigger!
        // Trigger w bazie:
        // 1. Doda naliczon premi do saldo_premii
        // 2. Odejmie wykorzystane_saldo
        // 3. Zaktualizuje procent_premii na nastpny zakup

        return zakupRepository.save(zakup); // Trigger zadziaa przy zapisie!
    }

    // ==================== METODY ODCZYTU ====================

    public List<Zakup> findAll() {
        return zakupRepository.findAll();
    }

    public Optional<Zakup> findById(Long id) {
        return zakupRepository.findById(id);
    }

    public Zakup getById(Long id) {
        return zakupRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Zakup nie znaleziony"));
    }

    public List<Zakup> findByKlientId(Long id) {
        return zakupRepository.findByKlientId(id);
    }

    public List<Zakup> findByPracownikId(Long id) {
        return zakupRepository.findByPracownikId(id);
    }

    public List<Zakup> findByDateRange(LocalDate od, LocalDate do_) {
        return zakupRepository.findByDataZakupuBetween(od, do_);
    }

    // ==================== METODY ZAPISU ====================

    public Zakup save(Zakup zakup) {
        return zakupRepository.save(zakup);
    }

    // ==================== METODY USUWANIA ====================

    public void remove(Long id) {
        Zakup zakup = zakupRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Zakup nie znaleziony"));
        zakupRepository.delete(zakup);
    }

    public void delete(Long id) {
        zakupRepository.deleteById(id);
    }

    // ==================== METODY POMOCNICZE ====================

    // Metoda do pobierania salda klienta (do wywietlania w UI)
    public BigDecimal pobierzSaldoKlienta(Long klientId) {
        Klient klient = klientRepository.findById(klientId)
                .orElseThrow(() -> new RuntimeException("Klient nie znaleziony"));
        return klient.getSaldoPremii();
    }

    // Nowa metoda: Sprawd藕 czy klient mo偶e wykorzysta saldo
    public boolean czyMozeWykorzystacSaldo(Long klientId, BigDecimal kwota) {
        if (kwota == null || kwota.compareTo(BigDecimal.ZERO) <= 0) {
            return false;
        }

        Klient klient = klientRepository.findById(klientId)
                .orElseThrow(() -> new RuntimeException("Klient nie znaleziony"));

        return klient.getSaldoPremii() != null &&
                klient.getSaldoPremii().compareTo(kwota) >= 0;
    }

    // ==================== METODY STATYSTYCZNE ====================

    public BigDecimal getSumaWydatkowKlienta(Long klientId) {
        List<Zakup> zakupy = findByKlientId(klientId);
        return zakupy.stream()
                .map(Zakup::getCenaZakupu)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    public BigDecimal getSumaWykorzystanegoSaldaKlienta(Long klientId) {
        List<Zakup> zakupy = findByKlientId(klientId);
        return zakupy.stream()
                .map(Zakup::getWykorzystaneSaldo)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    public int getLiczbaZakupowKlienta(Long klientId) {
        List<Zakup> zakupy = findByKlientId(klientId);
        return zakupy.size();
    }

    public BigDecimal getSredniaWartoscZakupuKlienta(Long klientId) {
        List<Zakup> zakupy = findByKlientId(klientId);
        if (zakupy.isEmpty()) {
            return BigDecimal.ZERO;
        }

        BigDecimal suma = getSumaWydatkowKlienta(klientId);
        return suma.divide(BigDecimal.valueOf(zakupy.size()), 2, RoundingMode.HALF_UP);
    }

    // ==================== METODY WALIDACYJNE ====================

    public boolean isSamochodKupiony(Long samochodId) {
        // Sprawd藕 czy istnieje zakup dla tego samochodu
        return zakupRepository.existsBySamochodId(samochodId);
    }

    public boolean isSamochodKupionyPrzezKlienta(Long samochodId, Long klientId) {
        return zakupRepository.existsBySamochodIdAndKlientId(samochodId, klientId);
    }

    // ==================== METODY RAPORTOWE ====================

    public List<Object[]> getStatystykiMiesieczne(int rok) {
        return zakupRepository.findMonthlyStatistics(rok);
    }

    public List<Object[]> getStatystykiRoczne() {
        return zakupRepository.findYearlyStatistics();
    }

    public List<Object[]> getTopKlienci(int limit) {
        return zakupRepository.findTopKlienci(limit);
    }

    public List<Object[]> getTopPracownicy(int limit) {
        return zakupRepository.findTopPracownicy(limit);
    }
}


CIEKA: C:\Users\Rafimaniaak\ProjektJAVA\komis-samochodowy3\src\main\java\pl\komis\model\Zakup.java
-------------------------------------------------------------------------------------------------------
package pl.komis.model;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.DynamicUpdate;

import java.time.LocalDate;
import java.math.BigDecimal;

@Entity
@Table(name = "zakupy")
@DynamicUpdate
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder(toBuilder = true)  // DODAJ toBuilder = true
public class Zakup {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "id_samochodu")
    private Samochod samochod;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "id_klienta")
    private Klient klient;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "id_pracownika")
    private Pracownik pracownik;

    private LocalDate dataZakupu;

    @Column(precision = 12, scale = 2)
    private BigDecimal cenaZakupu; // Cena ostateczna (po ewentualnym wykorzystaniu salda)

    @Column(name = "cena_bazowa", precision = 12, scale = 2)
    private BigDecimal cenaBazowa; // Cena przed zastosowaniem salda

    @Column(name = "zastosowany_rabat", precision = 5, scale = 2)
    private BigDecimal zastosowanyRabat = BigDecimal.ZERO; // Procent premii naliczonej

    @Column(name = "naliczona_premia", precision = 12, scale = 2)
    private BigDecimal naliczonaPremia = BigDecimal.ZERO; // Kwota premii z tego zakupu

    @Column(name = "wykorzystane_saldo", precision = 12, scale = 2)
    private BigDecimal wykorzystaneSaldo = BigDecimal.ZERO; // Kwota wykorzystanego salda

    // Alternatywnie: u偶yj @Builder.Default dla p贸l z domylnymi wartociami
    // @Builder.Default
    // private BigDecimal naliczonaPremia = BigDecimal.ZERO;

    // Metoda pomocnicza do obliczania zaoszczdzonej kwoty
    public BigDecimal getZaoszczedzonaKwota() {
        if (cenaBazowa != null && cenaZakupu != null) {
            return cenaBazowa.subtract(cenaZakupu);
        }
        return BigDecimal.ZERO;
    }

    // Metoda pomocnicza - czy wykorzystano saldo?
    public boolean czyWykorzystanoSaldo() {
        return wykorzystaneSaldo != null && wykorzystaneSaldo.compareTo(BigDecimal.ZERO) > 0;
    }
}


CIEKA: C:\Users\Rafimaniaak\ProjektJAVA\komis-samochodowy3\src\main\java\pl\komis\service\KlientService.java
-----------------------------------------------------------------------------------------------------------------
package pl.komis.service;

import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import pl.komis.model.Klient;
import pl.komis.repository.KlientRepository;

import java.math.BigDecimal;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class KlientService {

    private final KlientRepository klientRepository;

    public List<Klient> findAll() {
        return klientRepository.findAll();
    }

    public Optional<Klient> findById(Long id) {
        return klientRepository.findById(id);
    }

    public Optional<Klient> findByEmail(String email) {
        return klientRepository.findByEmail(email);
    }

    public Klient save(Klient klient) {
        return klientRepository.save(klient);
    }

    public void delete(Long id) {
        klientRepository.deleteById(id);
    }

    public Integer getLiczbaZakupow(Long klientId) {
        return klientRepository.findById(klientId)
                .map(Klient::getLiczbaZakupow)
                .orElse(0);
    }

    public BigDecimal getSaldoPremii(Long klientId) {
        return klientRepository.findById(klientId)
                .map(Klient::getSaldoPremii)
                .orElse(BigDecimal.ZERO);
    }

    public BigDecimal getProcentPremii(Long klientId) {
        return klientRepository.findById(klientId)
                .map(Klient::getProcentPremii)
                .orElse(BigDecimal.ZERO);
    }

    public BigDecimal getTotalWydane(Long klientId) {
        return klientRepository.findById(klientId)
                .map(Klient::getTotalWydane)
                .orElse(BigDecimal.ZERO);
    }
}


CIEKA: C:\Users\Rafimaniaak\ProjektJAVA\komis-samochodowy3\src\main\java\pl\komis\repository\ZakupRepository.java
----------------------------------------------------------------------------------------------------------------------
package pl.komis.repository;

import pl.komis.model.Zakup;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.List;

@Repository
public interface ZakupRepository extends JpaRepository<Zakup, Long> {

    List<Zakup> findByKlientId(Long klientId);

    List<Zakup> findByPracownikId(Long pracownikId);

    List<Zakup> findByDataZakupuBetween(LocalDate startDate, LocalDate endDate);

    // Dodaj te metody jeli ich nie ma:
    boolean existsBySamochodId(Long samochodId);

    boolean existsBySamochodIdAndKlientId(Long samochodId, Long klientId);

    @Query("SELECT YEAR(z.dataZakupu) as rok, MONTH(z.dataZakupu) as miesiac, " +
            "COUNT(z) as liczbaZakupow, SUM(z.cenaZakupu) as sumaSprzedazy " +
            "FROM Zakup z " +
            "WHERE YEAR(z.dataZakupu) = :rok " +
            "GROUP BY YEAR(z.dataZakupu), MONTH(z.dataZakupu) " +
            "ORDER BY rok, miesiac")
    List<Object[]> findMonthlyStatistics(@Param("rok") int rok);

    @Query("SELECT YEAR(z.dataZakupu) as rok, " +
            "COUNT(z) as liczbaZakupow, SUM(z.cenaZakupu) as sumaSprzedazy " +
            "FROM Zakup z " +
            "GROUP BY YEAR(z.dataZakupu) " +
            "ORDER BY rok")
    List<Object[]> findYearlyStatistics();

    @Query("SELECT z.klient, COUNT(z) as liczbaZakupow, SUM(z.cenaZakupu) as sumaWydatkow " +
            "FROM Zakup z " +
            "GROUP BY z.klient " +
            "ORDER BY sumaWydatkow DESC")
    List<Object[]> findTopKlienci(@Param("limit") int limit);

    @Query("SELECT z.pracownik, COUNT(z) as liczbaSprzedazy, SUM(z.cenaZakupu) as sumaSprzedazy " +
            "FROM Zakup z " +
            "GROUP BY z.pracownik " +
            "ORDER BY sumaSprzedazy DESC")
    List<Object[]> findTopPracownicy(@Param("limit") int limit);
}
